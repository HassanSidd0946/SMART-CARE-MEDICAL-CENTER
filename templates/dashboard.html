<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè• Smart Care - Live Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .status.connected {
            background: #10b981;
            color: white;
        }

        .status.disconnected {
            background: #ef4444;
            color: white;
        }

        .status.connecting {
            background: #f59e0b;
            color: white;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 3em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #64748b;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .bookings-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h2 {
            color: #1e293b;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        #bookingsList {
            list-style: none;
        }

        .booking-item {
            background: #f8fafc;
            border-left: 5px solid #667eea;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            animation: slideIn 0.5s ease-out;
            transition: all 0.3s ease;
        }

        .booking-item:hover {
            transform: translateX(10px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .booking-item.canceled {
            border-left-color: #ef4444;
            background: #fee2e2;
            opacity: 0.7;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .booking-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .patient-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #1e293b;
        }

        .booking-id {
            background: #667eea;
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.9em;
        }

        .booking-details {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 10px;
            color: #64748b;
            font-size: 0.95em;
        }

        .detail-label {
            font-weight: bold;
            color: #475569;
        }

        .timestamp {
            color: #94a3b8;
            font-size: 0.85em;
            margin-top: 10px;
            text-align: right;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #94a3b8;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè• Smart Care Medical Center</h1>
            <p style="color: #64748b; margin: 10px 0;">Real-Time Doctor Dashboard</p>
            <div style="margin-top: 15px;">
                <span id="connectionStatus" class="status connecting">‚è≥ Connecting...</span>
                <span id="connectionId" style="margin-left: 15px; color: #64748b;"></span>
            </div>
        </header>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalBookings">0</div>
                <div class="stat-label">Total Bookings Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeBookings">0</div>
                <div class="stat-label">Active Appointments</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="canceledBookings">0</div>
                <div class="stat-label">Canceled</div>
            </div>
        </div>

        <div class="bookings-container">
            <h2>üìÖ Live Bookings</h2>
            <ul id="bookingsList">
                <li class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <p>No bookings yet. Waiting for appointments...</p>
                    <p class="pulse" style="margin-top: 10px;">üî¥ Live</p>
                </li>
            </ul>
        </div>
    </div>

    <script>
        // WebSocket connection
        let ws = null;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 10;
        let reconnectDelay = 3000;
        let connectionId = null;
        let pingInterval = null;
        let isIntentionalClose = false;

        // Stats
        let totalBookings = 0;
        let activeBookings = 0;
        let canceledBookings = 0;

        // DOM elements
        const bookingsList = document.getElementById('bookingsList');
        const statusElement = document.getElementById('connectionStatus');
        const connectionIdElement = document.getElementById('connectionId');
        const totalBookingsElement = document.getElementById('totalBookings');
        const activeBookingsElement = document.getElementById('activeBookings');
        const canceledBookingsElement = document.getElementById('canceledBookings');

        function connectWebSocket() {
            // Prevent multiple connections
            if (ws && (ws.readyState === WebSocket.CONNECTING || ws.readyState === WebSocket.OPEN)) {
                console.log('‚ö†Ô∏è WebSocket already connected or connecting');
                return;
            }

            console.log('üîå Attempting WebSocket connection...');
            statusElement.className = 'status connecting';
            statusElement.textContent = '‚è≥ Connecting...';

            try {
                // Connect to WebSocket
                ws = new WebSocket('ws://localhost:4444/ws');

                ws.onopen = () => {
                    console.log('‚úÖ WebSocket Connected');
                    statusElement.className = 'status connected';
                    statusElement.textContent = 'üü¢ Connected';
                    reconnectAttempts = 0;

                    // Start ping interval (every 25 seconds)
                    if (pingInterval) {
                        clearInterval(pingInterval);
                    }
                    
                    pingInterval = setInterval(() => {
                        if (ws && ws.readyState === WebSocket.OPEN) {
                            console.log('üèì Sending ping...');
                            ws.send('ping');
                        }
                    }, 25000);
                };

                ws.onmessage = (event) => {
                    try {
                        const message = JSON.parse(event.data);
                        console.log('üì® Received:', message);
                        handleMessage(message);
                    } catch (e) {
                        console.error('‚ùå Error parsing message:', e);
                    }
                };

                ws.onerror = (error) => {
                    console.error('‚ùå WebSocket Error:', error);
                };

                ws.onclose = (event) => {
                    console.log('üîå WebSocket Closed', event.code, event.reason);
                    statusElement.className = 'status disconnected';
                    statusElement.textContent = 'üî¥ Disconnected';

                    // Clear ping interval
                    if (pingInterval) {
                        clearInterval(pingInterval);
                        pingInterval = null;
                    }

                    // Only reconnect if not intentionally closed and under max attempts
                    if (!isIntentionalClose && reconnectAttempts < maxReconnectAttempts) {
                        reconnectAttempts++;
                        const delay = reconnectDelay * reconnectAttempts;
                        console.log(`üîÑ Reconnecting in ${delay/1000}s (attempt ${reconnectAttempts}/${maxReconnectAttempts})...`);
                        
                        statusElement.textContent = `‚è≥ Reconnecting (${reconnectAttempts}/${maxReconnectAttempts})...`;
                        
                        setTimeout(() => {
                            connectWebSocket();
                        }, delay);
                    } else if (reconnectAttempts >= maxReconnectAttempts) {
                        statusElement.textContent = '‚ùå Connection failed';
                        console.error('‚ùå Max reconnection attempts reached');
                    }
                };

            } catch (error) {
                console.error('‚ùå Error creating WebSocket:', error);
                statusElement.className = 'status disconnected';
                statusElement.textContent = '‚ùå Connection error';
            }
        }

        function handleMessage(message) {
            switch (message.event) {
                case 'connected':
                    connectionId = message.connection_id;
                    connectionIdElement.textContent = `Connection #${connectionId}`;
                    console.log(`‚úÖ Assigned connection ID: ${connectionId}`);
                    break;

                case 'new_booking':
                    addBooking(message.data);
                    totalBookings++;
                    activeBookings++;
                    updateStats();
                    playNotificationSound();
                    break;

                case 'booking_canceled':
                    cancelBooking(message.data);
                    canceledBookings++;
                    activeBookings = Math.max(0, activeBookings - 1);
                    updateStats();
                    break;

                case 'pong':
                    console.log('üèì Pong received');
                    break;

                case 'system_message':
                    console.log(`üì¢ System: ${message.data.message}`);
                    break;

                default:
                    console.log('Unknown event:', message.event);
            }
        }

        function addBooking(data) {
            // Remove empty state
            const emptyState = bookingsList.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            // Create booking item
            const li = document.createElement('li');
            li.className = 'booking-item';
            li.id = `booking-${data.id}`;
            
            const time = new Date(data.timestamp);
            
            li.innerHTML = `
                <div class="booking-header">
                    <div class="patient-name">üë§ ${data.patient}</div>
                    <div class="booking-id">#${data.id}</div>
                </div>
                <div class="booking-details">
                    <span class="detail-label">üïê Time:</span>
                    <span>${data.time}</span>
                    
                    <span class="detail-label">ü©∫ Reason:</span>
                    <span>${data.reason}</span>
                    
                    ${data.phone ? `
                        <span class="detail-label">üì± Phone:</span>
                        <span>${data.phone}</span>
                    ` : ''}
                    
                    <span class="detail-label">üìä Status:</span>
                    <span style="color: #10b981; font-weight: bold;">‚úÖ ${data.status.toUpperCase()}</span>
                </div>
                <div class="timestamp">Booked at ${time.toLocaleTimeString()}</div>
            `;

            // Add to top of list
            bookingsList.insertBefore(li, bookingsList.firstChild);
        }

        function cancelBooking(data) {
            const bookingElement = document.getElementById(`booking-${data.id}`);
            if (bookingElement) {
                bookingElement.classList.add('canceled');
                
                const statusElement = bookingElement.querySelector('[style*="color: #10b981"]');
                if (statusElement) {
                    statusElement.style.color = '#ef4444';
                    statusElement.textContent = '‚ùå CANCELED';
                }
            }
        }

        function updateStats() {
            totalBookingsElement.textContent = totalBookings;
            activeBookingsElement.textContent = activeBookings;
            canceledBookingsElement.textContent = canceledBookings;
        }

        function playNotificationSound() {
            // Simple beep sound
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZTRQNUZXI7bBgGAc+ltryv3AgBi4A');
            audio.play().catch(() => {});
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            isIntentionalClose = true;
            if (pingInterval) {
                clearInterval(pingInterval);
            }
            if (ws) {
                ws.close();
            }
        });

        // Initialize connection
        connectWebSocket();
    </script>
</body>
</html>